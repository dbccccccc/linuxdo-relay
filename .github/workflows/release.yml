name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, windows, darwin]
        goarch: [amd64, arm64]
        exclude:
          - goos: windows
            goarch: arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          OUTPUT_NAME="linuxdo-relay-${{ matrix.goos }}-${{ matrix.goarch }}"
          if [ "${{ matrix.goos }}" = "windows" ]; then
            OUTPUT_NAME="${OUTPUT_NAME}.exe"
          fi
          go build -ldflags="-s -w -X main.Version=${{ github.ref_name }}" -o "${OUTPUT_NAME}" ./cmd/server
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-${{ matrix.goos }}-${{ matrix.goarch }}
          path: linuxdo-relay-*

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./web
        run: npm ci

      - name: Build frontend
        working-directory: ./web
        run: npm run build

      - name: Create frontend archive
        run: |
          cd web/dist
          tar -czf ../../linuxdo-relay-web.tar.gz .
          cd ../..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend
          path: linuxdo-relay-web.tar.gz

  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ github.ref_name }}
          provenance: false
          sbom: false

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend, build-docker]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          # Backend binaries
          find artifacts/backend-* -type f -exec cp {} release/ \;
          # Frontend
          cp artifacts/frontend/linuxdo-relay-web.tar.gz release/
          # Docker compose
          cp docker-compose.yml release/
          # Create checksums
          cd release
          sha256sum * > checksums.txt
          cd ..

      - name: Generate release notes
        id: release_notes
        run: |
          cat << EOF > release_notes.md
          ## ğŸš€ LinuxDo-Relay ${{ github.ref_name }}

          ### ğŸ“¦ ä¸‹è½½è¯´æ˜

          #### äºŒè¿›åˆ¶æ–‡ä»¶
          - \`linuxdo-relay-linux-amd64\`: Linux (x86_64)
          - \`linuxdo-relay-linux-arm64\`: Linux (ARM64)
          - \`linuxdo-relay-darwin-amd64\`: macOS (Intel)
          - \`linuxdo-relay-darwin-arm64\`: macOS (Apple Silicon)
          - \`linuxdo-relay-windows-amd64.exe\`: Windows (x86_64)

          #### å‰ç«¯é™æ€æ–‡ä»¶
          - \`linuxdo-relay-web.tar.gz\`: å‰ç«¯æ„å»ºäº§ç‰©

          ### ğŸ³ Docker é•œåƒ

          \`\`\`bash
          # GitHub Container Registry
          docker pull ghcr.io/${{ github.repository }}:${{ github.ref_name }}
          \`\`\`

          ### ğŸ“– å¿«é€Ÿå¼€å§‹

          #### ä½¿ç”¨äºŒè¿›åˆ¶æ–‡ä»¶

          1. ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
          2. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå‚è€ƒ README.mdï¼‰
          3. è¿è¡Œç¨‹åºï¼š\`./linuxdo-relay-linux-amd64\`ï¼ˆè‡ªåŠ¨è¿ç§»æ•°æ®åº“ï¼‰

          #### ä½¿ç”¨ Docker Compose

          1. ä¸‹è½½ \`docker-compose.yml\`
          2. é…ç½®ç¯å¢ƒå˜é‡
          3. è¿è¡Œï¼š\`docker-compose up -d\`

          ### ğŸ“‹ æ›´æ–°æ—¥å¿—

          è¯¦è§æäº¤å†å²ã€‚

          ### âš ï¸ é‡è¦æç¤º

          - é¦–æ¬¡éƒ¨ç½²è¯·åŠ¡å¿…é…ç½® \`APP_JWT_SECRET\` å’Œ LinuxDo OAuth å‡­è¯
          - ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ HTTPS
          - å®šæœŸå¤‡ä»½æ•°æ®åº“

          ### ğŸ” éªŒè¯ä¸‹è½½

          ä½¿ç”¨ \`checksums.txt\` éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š

          \`\`\`bash
          sha256sum -c checksums.txt
          \`\`\`

          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
